<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script src="https://unpkg.com/vue"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-red.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link rel="stylesheet" href="/style/main.css">
</head>

<body>
    <div id="app">
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title">管理題庫</span>
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <!-- Navigation. We hide it in small screens. -->
                    <nav class="mdl-navigation mdl-layout--large-screen-only">
                        <a class="mdl-navigation__link" href="">Link</a>
                        <a class="mdl-navigation__link" href="">Link</a>
                        <a class="mdl-navigation__link" href="">Link</a>
                        <a class="mdl-navigation__link" href="">Link</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title">圖書室搶答系統</span>
                <nav class="mdl-navigation">
                    <a v-for="link in links" class="mdl-navigation__link" v-bind:href="link.href">{{link.text}}</a>
                </nav>
            </div>
            <main class="mdl-layout__content">
                <div class="page-content">
                    <div class="mdl-grid">
                        <div class="mdl-layout-spacer"></div>

                        <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                            <thead>
                                <tr>
                                    <th class="">刪除/新增</th>
                                    <th v-for="field in fields">{{field.name}}</th>
                                </tr>
                            </thead>
                            <tbody>

                                <tr>
                                    <td>
                                        <button v-on:click="add()" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
                                            <i class="material-icons">add</i>
                                        </button>
                                    </td>
                                </tr>

                                <tr v-for="problem in problems">
                                    <td>
                                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
                                                <i v-on:click="problem.del()" class="material-icons">delete</i>
                                            </button>
                                    </td>


                                    <td v-if="edit_problem!=null&amp;&amp;edit_problem._id==problem._id" v-bind:colspan="fields.length">
                                        <div class="demo-card-wide mdl-card mdl-shadow--2dp">

                                            <div class="mdl-card__title">
                                                <h2 class="mdl-card__title-text">{{problem.title}}</h2>
                                            </div>
                                            <div class="mdl-card__supporting-text">
                                                {{problem.desc}}
                                            </div>
                                            <div class="mdl-card__actions mdl-card--border">
                                            </div>
                                            <div class="mdl-card__menu">
                                                <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
                                                    <i class="material-icons">edit-mode</i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td v-else v-for="field in fields" v-on:click="edit_problem=problem">
                                        <span>{{problem[field.name]}}</span>
                                    </td>
                                </tr>

                            </tbody>
                        </table>

                        <div class="mdl-layout-spacer"></div>

                    </div>
                </div>
            </main>
        </div>
    </div>
</body>

<script src="/js/dog.js"></script>
<script src="/js/objapi.js"></script>
<script>
    var data = {
        links: [
            {
                href: dog.url('/operate/team'),
                text: '參賽隊伍'
            },
            {
                href: dog.url('/operate/problem'),
                text: '題庫'
            }
        ],
        edit_field: null,
        edit_problem: null,
        problems: [],
        add: function () {
            dog.request('post', '/addproblem', {
                count: 1
            }).then(update)
        },
        fields: []
    }

    var app = new Vue({ el: '#app', data });

    function update() {

        dog.request('get', '/problem').then(problems => {
            problems = JSON.parse(problems);

            problems.map(problem => {
                problem.del = function () {
                    dog.request('post', '/delproblem', {
                        ids: [problem._id]
                    }).then(update)
                }
            })

            data.problems = problems;

            dog.request('get', '/setproblem').then(doc => {
                doc = JSON.parse(doc);
                data.fields = doc.fields.filter(f => f.name == "value")[0].value.fields;
            })

        })

    }
    update();

</script>

</html>