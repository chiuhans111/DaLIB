<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>編輯比賽</title>
    <link rel="stylesheet" href="/style/main.css">

</head>

<body>
    <div id="app">
        <v-app>

            <v-container>

                <v-layout>
                    <v-flex md10 offset-md1 sm10 offset-sm1 xs12>
                        <v-card class="mt-4">
                            <template v-if="state!=0">
                                <v-layout>


                                    <v-btn primary @click="begin()">
                                        開始比賽
                                    </v-btn>

                                    <v-btn flat :href="'/page/member/print.html?/key/'+key">
                                        列印QRCODE
                                    </v-btn>

                                    <v-btn flat :href="'/page/member/sheet.html?/key/'+key">
                                        列印題目卷
                                    </v-btn>

                                    <v-btn flat color="red" @click="resetPlay()">
                                        清除比賽紀錄
                                    </v-btn>

                                </v-layout>
                                <hr>
                            </template>



                            <v-card-title primary-title>
                                <div>

                                    <h3 class="headline mb-0 primary--text">
                                        <template v-if="state==0">
                                            教師登入
                                        </template>

                                        <template v-else-if="state==1">

                                            <v-tooltip left>
                                                <v-btn icon slot="activator" @click.stop="editName()">
                                                    <v-icon>edit</v-icon>
                                                </v-btn>
                                                <span>編輯名稱</span>
                                            </v-tooltip>

                                            {{content.name}}
                                        </template>
                                        <template v-else-if="state==2">
                                            <v-btn flat @click="state=1">返回比賽</v-btn>
                                            場次內容
                                        </template>
                                        <template v-else-if="state==3">
                                            <v-btn flat @click="state=2">返回場次</v-btn>
                                            問題內容
                                        </template>
                                        <template v-else-if="state=='txt'">
                                            <v-btn flat @click="state=1">返回比賽</v-btn>
                                            文字編輯模式
                                        </template>

                                        <template v-if="state!=0">

                                            <v-tooltip right>
                                                <v-btn icon slot="activator" @click.stop="save()">
                                                    <v-icon>save</v-icon>
                                                </v-btn>
                                                <span>儲存變更</span>
                                            </v-tooltip>
                                            <small style="color:gray; font-size:0.5em">{{saveMessage}}</small>





                                        </template>

                                        <v-btn v-if="state==1" flat primary @click="state='txt'">
                                            文字編輯模式
                                        </v-btn>


                                    </h3>

                                </div>
                            </v-card-title>
                            <v-progress-linear v-bind:indeterminate="loading"></v-progress-linear>
                            <v-card-text>
                                <transition-group name="list">
                                    <template v-if="state==0">

                                        <v-layout :key="1">


                                            <v-flex md8>
                                                <v-container>
                                                    <p>請使用你的密碼登入</p>
                                                    <v-text-field label="密碼" v-model="key"></v-text-field>
                                                    <v-btn primary @click=" window.location.href = '/page/member/edit.html?/key/' + key;">下一步</v-btn>
                                                </v-container>
                                            </v-flex>

                                            <v-flex>
                                                <v-container>
                                                    <p>或是?</p>
                                                    <v-btn primary href="./create.html">建立新的比賽</v-btn>
                                                    <v-btn @click="cancel()">取消</v-btn>
                                                </v-container>
                                            </v-flex>

                                        </v-layout>

                                    </template>

                                    <template v-if="state==1">
                                        <div key="1">

                                            <p class="mb-0 primary--text">
                                                場次 | ROUNDS

                                                <v-btn icon @click.stop="roundop().add()">
                                                    <v-icon>add</v-icon>
                                                </v-btn>
                                            </p>
                                            <v-list two-line>
                                                <transition-group name="list">
                                                    <template v-for="(round, index) in content.rounds">
                                                        <v-list-tile @click="editRound(index)" avatar :key="JSON.stringify(round)">
                                                            <v-list-tile-content>
                                                                <v-list-tile-title>{{round.name}}</v-list-tile-title>
                                                                <v-list-tile-sub-title>{{round.players}}人</v-list-tile-sub-title>
                                                            </v-list-tile-content>


                                                            <v-btn icon @click.stop="roundop().move(index,-1)">
                                                                <v-icon>keyboard_arrow_up</v-icon>
                                                            </v-btn>


                                                            <v-btn icon @click.stop="roundop().move(index,+1)">
                                                                <v-icon>keyboard_arrow_down</v-icon>
                                                            </v-btn>

                                                            <v-btn icon @click.stop="roundop().del(index)">
                                                                <v-icon>delete</v-icon>
                                                            </v-btn>

                                                        </v-list-tile>
                                                    </template>
                                                </transition-group>
                                            </v-list>


                                        </div>
                                    </template>

                                    <template v-if="state=='txt'">
                                        <div key="2">

                                            <v-layout row>
                                                <v-btn primary @click="parseText()">確認</v-btn>
                                            </v-layout>

                                            <v-text-field label="請在此輸入" multi-line auto-grow v-model="textInput"></v-text-field>

                                            <v-layout row v-if="textInput.length>1000">
                                                <v-btn primary @click="parseText()">確認</v-btn>
                                            </v-layout>

                                        </div>
                                    </template>


                                    <template v-if="state==2">
                                        <div key="2">
                                            <p class="mb-0 primary--text">
                                                場次 | ROUND
                                            </p>

                                            <v-layout row>
                                                <v-flex xs4>
                                                    <v-text-field label="場次名稱" v-model="content.rounds[round].name"></v-text-field>
                                                </v-flex>
                                                <v-flex xs4>
                                                    <v-text-field label="組數" v-model="content.rounds[round].players"></v-text-field>
                                                </v-flex>
                                                <v-flex xs4>
                                                    <v-checkbox label="使用搶答按鈕?" v-model="content.rounds[round].usebutton"></v-checkbox>
                                                </v-flex>
                                            </v-layout>

                                            <blockquote>
                                                <p class="mb-0 primary--text">
                                                    題目 | PROBLEMS
                                                    <v-btn icon @click.stop="problemop().add()">
                                                        <v-icon>add</v-icon>
                                                    </v-btn>
                                                    <v-btn icon @click.stop="problemop().add()">
                                                        <v-icon>edit</v-icon>
                                                    </v-btn>

                                                </p>

                                                <v-list two-line>
                                                    <transition-group name="list">
                                                        <template v-for="(problem, index) in content.rounds[round].problems">
                                                            <v-list-tile @click="editProblem(index)" avater :key="JSON.stringify(problem)">
                                                                <v-list-tile-content>
                                                                    <v-list-tile-title>
                                                                        <strong>{{index+1}}. {{problem.title}}</strong>
                                                                        {{problem.content}}
                                                                    </v-list-tile-title>
                                                                    <v-list-tile-sub-title>
                                                                        {{problem.score}}分
                                                                        <template v-for="c in problem.choice">
                                                                            <span>({{c.value}}) {{c.content}} </span>
                                                                        </template>
                                                                    </v-list-tile-sub-title>
                                                                </v-list-tile-content>


                                                                <v-list-tile-action>
                                                                    <v-btn icon @click.stop="problemop().move(index,-1)">
                                                                        <v-icon>keyboard_arrow_up</v-icon>
                                                                    </v-btn>

                                                                </v-list-tile-action>
                                                                <v-list-tile-action>
                                                                    <v-btn icon @click.stop="problemop().move(index,+1)">
                                                                        <v-icon>keyboard_arrow_down</v-icon>
                                                                    </v-btn>




                                                                </v-list-tile-action>
                                                                <v-list-tile-action>
                                                                    <v-btn icon @click.stop="problemop().del(index)">
                                                                        <v-icon>delete</v-icon>
                                                                    </v-btn>
                                                                </v-list-tile-action>

                                                            </v-list-tile>
                                                        </template>
                                                    </transition-group>
                                                </v-list>
                                            </blockquote>
                                        </div>
                                    </template>



                                    <template v-if="state==3">
                                        <template>
                                            <div class="text-xs-center" key="3k">
                                                <v-layout row>

                                                    <v-flex sm9>
                                                        <v-pagination :length="content.rounds[round].problems.length" v-model="problem2" :total-visible="7"></v-pagination>
                                                    </v-flex>
                                                    <v-flex sm3>
                                                        新增題目
                                                        <v-btn icon @click.stop="problemop().add()">
                                                            <v-icon>add</v-icon>
                                                        </v-btn>
                                                        <v-btn icon @click.stop="problemop().del(problem)">
                                                            <v-icon>delete</v-icon>
                                                        </v-btn>
                                                    </v-flex>
                                                </v-layout>
                                            </div>
                                        </template>

                                        <div :key="3+':'+problem">

                                            <blockquote>
                                                <v-layout row>
                                                    <!--
                                                    <v-flex sm3 class="mr-5">
                                                        <v-text-field label="標題" v-model="content.rounds[round].problems[problem].title"></v-text-field>
                                                    </v-flex>
                                                    -->
                                                    <v-flex sm12>
                                                        <v-text-field label="題目" v-model="content.rounds[round].problems[problem].content" multi-line auto-grow></v-text-field>
                                                    </v-flex>
                                                </v-layout>
                                                <v-layout row>
                                                    <v-flex sm6 class="mr-5">
                                                        <v-text-field label="得分" v-model="content.rounds[round].problems[problem].score" type="number" suffix="分"></v-text-field>
                                                    </v-flex>
                                                    <v-flex sm6>
                                                        <v-text-field label="作答時間" v-model="content.rounds[round].problems[problem].timeout" type="number" suffix="秒"></v-text-field>
                                                    </v-flex>
                                                </v-layout>
                                                <p class="mb-0 primary--text">
                                                    答案 | ANSWER
                                                </p>
                                                <v-layout row>
                                                    <v-flex sm1 class="mr-5">
                                                        <v-text-field label="選項" v-model="content.rounds[round].problems[problem].answer.value"></v-text-field>
                                                    </v-flex>
                                                    <v-flex sm10>
                                                        <v-text-field label="說明" v-model="content.rounds[round].problems[problem].answer.description"></v-text-field>
                                                    </v-flex>
                                                </v-layout>
                                            </blockquote>
                                            <p class="mb-0 primary--text">
                                                選項 | CHOICES
                                                <v-btn icon @click.stop="choiceop().add()">
                                                    <v-icon>add</v-icon>
                                                </v-btn>
                                            </p>
                                            <template v-for="(choice, index) in content.rounds[round].problems[problem].choice">


                                                <v-layout row wrap>
                                                    <v-flex sm1>
                                                        <v-text-field label="選項" v-model="choice.value"></v-text-field>
                                                    </v-flex>
                                                    <v-flex sm6>
                                                        <v-text-field label="內容" v-model="choice.content"></v-text-field>
                                                    </v-flex>

                                                    <v-flex sm5>


                                                        <v-btn icon @click.stop="choiceop().move(index,-1)">
                                                            <v-icon>keyboard_arrow_up</v-icon>
                                                        </v-btn>

                                                        <v-btn icon @click.stop="choiceop().move(index,+1)">
                                                            <v-icon>keyboard_arrow_down</v-icon>
                                                        </v-btn>

                                                        <v-btn icon @click.stop="choiceop().del(index)">
                                                            <v-icon>delete</v-icon>
                                                        </v-btn>


                                                    </v-flex>

                                                </v-layout>

                                            </template>

                                        </div>
                                    </template>

                                </transition-group>

                                <!--
                                <template v-if="state==1||state==2">

                                    <p class="primary--text">
                                        參賽隊伍 | TEAMS
                                        <v-btn flat @click="_=>genQR(content.teams.filter(team=>state==1||team.round>=round))">產生所有 QRcode</v-btn>
                                    </p>

                                    <transition-group name="list">
                                        <template v-for="team in content.teams">
                                            <v-chip @click="showTeam(team.no)" :key="team.no" outline :color="(state>1&amp;&amp;team.round>=round)?'primary':'gray'">
                                                <strong>{{team.name}}</strong>
                                                <span>{{team.score}}分</span>
                                            </v-chip>
                                        </template>
                                    </transition-group>

                                </template>
                            -->
                            </v-card-text>

                        </v-card>
                    </v-flex>

                </v-layout>
                <template v-if="state!=0">

                    <v-dialog v-model="teamDialog">
                        <v-card>
                            <v-card-title class="headline">{{teamDialogContent.title}}</v-card-title>
                            <v-card-text>{{teamDialogContent.text}}</v-card-text>
                            <v-card-text>
                                <img :src="teamDialogContent.qrcode" :alt="teamDialogContent.text">
                            </v-card-text>
                            <template v-if="content.teams[teamDialogContent.no]">
                                <v-card-text>
                                    <v-text-field v-model="content.teams[teamDialogContent.no].score" type="number" label="分數" suffix="分"></v-text-field>
                                    <v-text-field v-model="content.teams[teamDialogContent.no].round" type="number" label="晉級" suffix="場"></v-text-field>
                                </v-card-text>
                            </template>

                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn flat @click.native="teamDialog = false">關閉</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                    <my-dialog v-model="dialog_setup" @ok="dialog_ok"></my-dialog>
                </template>

            </v-container>


        </v-app>
    </div>
    <script src="/dist/general.js"></script>
    <script src="/sample/contest.js"></script>
    <script>
        var data = {
            window,
            loading: false,
            state: 0,
            key: '',
            content: "",
            login() {
                data.loading = true;
                dog.request('get', '/api/member/contest/view/key/' + data.key).then(content => {
                    data.content = JSON.parse(content);
                    data.state = 1;
                    data.saved = content;
                    data.loading = false;

                    window.onbeforeunload = function () {
                        if (data.saved != JSON.stringify(data.content)) return "有變更尚未儲存，確定要捨棄這些變更嗎?";
                    }
                })
            },
            autoSave: false,
            saveMessage: "自動儲存已開啟",
            saved: "",
            savetime: new Date().getTime(),
            save() {
                data.loading = true;
                dog.request('post', '/api/member/contest/update/key/' + data.key, data.content).then(x => {
                    data.saved = JSON.stringify(data.content)
                    data.loading = false;
                    data.savetime = new Date().getTime();
                })
            },

            editName() {
                data.dialog_setup = [
                    { title: "修改比賽名稱" },
                    { text: `這場比賽叫什麼名字呢` },
                    {
                        input: {
                            name: 'name',
                            value: data.content.name,
                            label: '名稱'
                        }
                    }
                ]
                data.dialog_ok = function (result) {
                    data.content.name = result.name;
                }
            },
            round: 0,   // index of current round
            editRound(round) {
                data.round = round;
                data.state = 2;
            },
            problem: 0, // index of current problem
            get problem2() {
                return this.problem + 1;
            },
            set problem2(value) {
                this.problem = value - 1;
            },
            editProblem(problem) {
                data.problem = problem;
                data.state = 3;
            },

            teamDialog: false,
            teamDialogContent: {},
            showTeam(no) {
                var team = data.content.teams[no];
                dog.request('post', '/api/qrcode/', {
                    data: team.key
                }).then(src => {

                    data.teamDialog = true;
                    data.teamDialogContent = {
                        title: team.name,
                        text: team.key,
                        qrcode: src,
                        no
                    }
                })
            },

            // DIALOG
            dialog_setup: null,
            dialog_ok: function () { },

            roundop() {
                return arr(data.content, 'rounds', _ => {
                    var round = sampleContest().rounds[0];
                    round.players = data.content.teams.length;
                    return round;
                })
            },
            problemop() {
                return arr(data.content.rounds[data.round], 'problems', _ => {
                    var problem = sampleContest().rounds[0].problems[0]
                    if (data.content.rounds[data.round].usebutton) problem.choice = [];
                    return problem
                })
            },
            choiceop() {
                return arr(data.content.rounds[data.round].problems[data.problem], 'choice', _ => {
                    var c = data.content.rounds[data.round].problems[data.problem].choice;
                    var cc = sampleContest().rounds[0].problems[0].choice[0];
                    if (c.length > 0) cc.value = String.fromCharCode(c[c.length - 1].value.charCodeAt() + 1)
                    return cc;
                })
            }, genQR() {

            }, cancel() {
                history.go(-1)
            },

            resetPlay() {
                data.dialog_setup = [
                    { title: "確定清除比賽紀錄嗎？" },
                    { text: `分數、答題紀錄都會被刪除` }
                ]
                data.dialog_ok = function (result) {
                    data.content.teams = data.content.teams.map(team => {
                        team.score = 0;
                        team.record = [];
                        return team;
                    });
                }
            },


            textInput: '',
            parseText() {
                var text = this.textInput;
                var lines = text.split('\n');

                var rounds = [];




                var CurrentRound = null;
                var CurrentProblem = null;

                function matchKey(content, key) {
                    var regex = "^\\s*" + key + "\\s*[：:]\\s*(.*)\\s*$";
                    return content.match(regex);
                }


                function newRound() {
                    CurrentRound = sampleContest().rounds[0];
                    CurrentRound.problems = [];
                    CurrentRound.players = data.content.teams.length;
                    rounds.push(CurrentRound);
                }

                function newProblem() {
                    CurrentProblem = sampleContest().rounds[0].problems[0];
                    CurrentProblem.choice = [];
                    CurrentRound.problems.push(CurrentProblem);
                }

                var inContent = false;

                for (var i in lines) {

                    var line = lines[i];
                    if (line.trim().length == 0) continue;

                    var round = matchKey(line, "階段")
                    var answer = matchKey(line, "解答");
                    var desc = matchKey(line, "解析");
                    var usebutton = line.match("搶答");
                    var choice = line.match(/^\s*[（\(]([A-Za-zＡ-Ｚａ-ｚ\s]+)[）\)]\s*(.+)\s*$/);


                    var matched = true;

                    if (round) {
                        newRound();
                        CurrentRound.name = round[1];

                    } else if (answer) {
                        var answers = CurrentProblem.choice.map(x => x.value)
                            .filter(x => answer[1].indexOf(x) != -1);
                        CurrentProblem.answer.value = answers.join("");

                    } else if (desc) {
                        CurrentProblem.answer.description = desc[1];

                    } else if (choice) {
                        console.log(CurrentRound.problems.length, CurrentProblem.choice)
                        CurrentProblem.choice.push({
                            value: choice[1],
                            content: choice[2]
                        })

                    } else if (usebutton) {
                        CurrentRound.usebutton = true;

                    } else {
                        matched = false;
                        if (!inContent) newProblem();
                        CurrentProblem.content += line + '\n';
                        inContent = true;
                    }

                    if (matched) inContent = false;

                }
                this.content.rounds = rounds;
                this.state = 1;

            }

        }

        var app = done({
            data,
            computed: {
                changed() {
                    return JSON.stringify(this.content) != this.saved;
                }
            },
            methods: {
                begin() {
                    data.loading = true;
                    dog.keyrequest('get', '/api/member/round/start').then(result => {
                        console.log(result)
                        location.href = '/play.html?/key/' + dog.key;
                    })
                }
            }
        });
        var key = dog.key;
        if (key) {
            console.log('has key')
            data.key = key;
            data.login();
        }
        // a helper object for arrays operate
        function arr(obj, att, addg) {
            return {
                add: function () {
                    obj[att].push(addg());
                },
                del: function (index) {
                    data.dialog_setup = [
                        { title: "確認刪除" },
                        { text: `資料將被標記為刪除` }
                    ]
                    data.dialog_ok = function () {
                        obj[att].splice(index, 1);
                    }
                },
                move: function (index, to) {
                    to += index;
                    if (to >= 0 && to < obj[att].length) {
                        var tmp = obj[att][index];
                        obj[att][index] = obj[att][to];
                        obj[att][to] = tmp;
                    }
                    obj[att] = JSON.parse(JSON.stringify(obj[att]))
                },
                refresh: function () {
                    obj[att] = JSON.parse(JSON.stringify([att]))
                },

            }
        }

        function autoSave() {
            var currentJson = JSON.stringify(data.content);

            if (currentJson != data.saved) {
                if (data.autoSave) {
                    data.save();
                    data.saveMessage = "自動儲存..";
                }
                else data.saveMessage = "有變更尚未儲存";
            } else {
                var savetilnow = new Date().getTime() - data.savetime;
                var second = savetilnow = Math.round(savetilnow / 1000);
                var minute = Math.round(second / 60);
                var hour = Math.round(minute / 60);
                if (second < 60)
                    data.saveMessage = second + " 秒前已儲存所有變更";
                else if (minute < 60) {
                    data.saveMessage = minute + " 分鐘前已儲存所有變更";
                } else data.saveMessage = hour + " 小時前已儲存所有變更";
            }

            setTimeout(() => {
                autoSave();
            }, 1000);
        }
        autoSave();


    </script>
</body>

</html>